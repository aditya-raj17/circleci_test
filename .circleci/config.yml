version: 2.1

jobs:
  build:
    docker:
      - image: adityablitz/flutter-3.24.2:latest

    steps:
      - checkout
      
      # Restore combined cache for Flutter and Gradle dependencies
      - restore_cache:
          keys:
            - flutter-deps-v1-{{ checksum "pubspec.lock" }}
            - flutter-deps-v1-
            
      - run:
          name: "Creating Env file"
          command: |
            if [[ "${CIRCLE_BRANCH}" == "main" ]]; then
              echo "Creating .env file for production environment"
              cat > .env \<< EOF
            REALM=${REALM_PRD}
            EOF
              echo "Environment file created:"
              cat .env
            else
              echo "Branch not configured for builds"
              exit 1
            fi

      - run:
          name: Clean Flutter Build
          command: flutter clean
          
      - run:
          name: "Install dependencies"
          command: flutter pub get

      - run:
          name: Install Shorebird CLI
          command: |
            if [[ "${CIRCLE_BRANCH}" == "main" ]]; then
              echo "Installing Shorebird CLI for production branch..."
              curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
              echo 'export PATH="$HOME/.shorebird/bin:$PATH"' >> $BASH_ENV
              source $BASH_ENV
            else
              echo "Skipping Shorebird installation for non-production branch"
            fi

      - run:
          name: Set Shorebird token
          command: |
            if [[ "${CIRCLE_BRANCH}" == "main" ]]; then
              export SHOREBIRD_TOKEN="$SHOREBIRD_TOKEN"
              echo "Shorebird token set"
            fi
      
      - run:
          name: Shorebird Intelligent Deploy (Patch or Release)
          no_output_timeout: 20m
          command: |
            #!/bin/bash
            set -e # Exit immediately if a command exits with a non-zero status.
            
            # Create log file for Shorebird operations
            SHOREBIRD_LOG="shorebird_deploy.log"
            echo "ðŸš€ Starting Shorebird Intelligent Deploy - $(date)" | tee -a "$SHOREBIRD_LOG"

            echo "Early exit"
            exit 0

            # Add lightweight periodic output to prevent timeout
            (while true; do 
              echo "â³ Still working... $(date +%H:%M:%S)" | tee -a "$SHOREBIRD_LOG"
              # Simplified resource monitoring (less overhead)
              echo "ðŸ“Š Load: $(cat /proc/loadavg | cut -d' ' -f1-3 2>/dev/null || echo 'N/A')" | tee -a "$SHOREBIRD_LOG"
              sleep 90
            done) &
            KEEPALIVE_PID=$!

            # Step 1: Select the correct Shorebird App ID based on the branch.
            if [[ "${CIRCLE_BRANCH}" == "main" ]]; then
              SHOREBIRD_APP_ID=$SHOREBIRD_APP_ID_PROD
            elif [[ "${CIRCLE_BRANCH}" == "pre-prod-main" ]]; then
              SHOREBIRD_APP_ID=$SHOREBIRD_APP_ID_PRE_PROD
            elif [[ "${CIRCLE_BRANCH}" == "stag-main" ]]; then
              SHOREBIRD_APP_ID=$SHOREBIRD_APP_ID_STAG
            else 
              SHOREBIRD_APP_ID=$SHOREBIRD_APP_ID_DEV
            fi
            
            if [ -z "$SHOREBIRD_APP_ID" ]; then
              echo "âŒ ERROR: Shorebird App ID for branch ${CIRCLE_BRANCH} is not set."
              exit 1
            fi
            
            echo "ðŸŽ¯ Using Shorebird App ID: ${SHOREBIRD_APP_ID} for branch ${CIRCLE_BRANCH}" | tee -a "$SHOREBIRD_LOG"
            echo "app_id: $SHOREBIRD_APP_ID" > shorebird.yaml
            echo "auto_update: false" >> shorebird.yaml
            echo "Generated shorebird.yaml:" | tee -a "$SHOREBIRD_LOG"
            cat shorebird.yaml | tee -a "$SHOREBIRD_LOG"

            # Step 2: Get version from pubspec.yaml
            VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
            echo "export VERSION='$VERSION'" >> $BASH_ENV
            echo "ðŸ”Ž Current app version is $VERSION" | tee -a "$SHOREBIRD_LOG"
            
            # Network connectivity check
            echo "ðŸŒ Checking network connectivity..." | tee -a "$SHOREBIRD_LOG"
            curl -s --connect-timeout 5 https://api.shorebird.dev/health > /dev/null && echo "âœ… Shorebird API reachable" | tee -a "$SHOREBIRD_LOG" || echo "âš ï¸ Shorebird API unreachable" | tee -a "$SHOREBIRD_LOG"

            # Step 3: Always attempt to patch first.
            echo -e "\nâ³ Attempting to patch release $VERSION..." | tee -a "$SHOREBIRD_LOG"
            echo "ðŸ• Patch start time: $(date)" | tee -a "$SHOREBIRD_LOG"
            PATCH_START_TIME=$(date +%s)
            PATCH_OUTPUT=$(shorebird patch android --release-version="$VERSION" --no-confirm 2>&1 | tee -a "$SHOREBIRD_LOG" || true)
            PATCH_END_TIME=$(date +%s)
            PATCH_DURATION=$((PATCH_END_TIME - PATCH_START_TIME))
            echo "â±ï¸ Patch attempt took: ${PATCH_DURATION} seconds" | tee -a "$SHOREBIRD_LOG"

            # Step 4: Analyze the patch command's output
            if echo "$PATCH_OUTPUT" | grep -q "âœ… Published Patch"; then
              # CASE 1: Patch successful. Job is done.
              PATCH_NUMBER=$(echo "$PATCH_OUTPUT" | grep -o "âœ… Published Patch [0-9]*" | grep -o "[0-9]*" || echo "")
              echo "export PATCH_NUMBER='$PATCH_NUMBER'" >> $BASH_ENV
              echo "âœ… Successfully published patch $PATCH_NUMBER for version $VERSION." | tee -a "$SHOREBIRD_LOG"
              echo "export DEPLOYMENT_TYPE=1" >> $BASH_ENV
              echo "ðŸŽ‰ Shorebird deployment completed successfully - $(date)" | tee -a "$SHOREBIRD_LOG"
              exit 0

            elif echo "$PATCH_OUTPUT" | grep -q "Release not found"; then
              # CASE 2: Release does not exist. Attempt to create it.
              echo -e "\nâ„¹ï¸ No existing release found for $VERSION. Attempting to create a new release..." | tee -a "$SHOREBIRD_LOG"
              echo "ðŸ• Release start time: $(date)" | tee -a "$SHOREBIRD_LOG"
              RELEASE_START_TIME=$(date +%s)
              RELEASE_OUTPUT=$(shorebird release android --flutter-version=3.24.2 --no-confirm 2>&1 | tee -a "$SHOREBIRD_LOG" || true)
              RELEASE_END_TIME=$(date +%s)
              RELEASE_DURATION=$((RELEASE_END_TIME - RELEASE_START_TIME))
              echo "â±ï¸ Release creation took: ${RELEASE_DURATION} seconds" | tee -a "$SHOREBIRD_LOG"

              # Step 5: Analyze the release command's output
              if echo "$RELEASE_OUTPUT" | grep -q "âœ… Published Release"; then
                # CASE 2a: Release successful.
                echo "âœ… Successfully published new release for version $VERSION." | tee -a "$SHOREBIRD_LOG"
                echo "export DEPLOYMENT_TYPE=0" >> $BASH_ENV
                echo "ðŸŽ‰ Shorebird release completed successfully - $(date)" | tee -a "$SHOREBIRD_LOG"
                exit 0
              elif echo "$RELEASE_OUTPUT" | grep -q "existing android release for version"; then
                echo -e "\nâŒ ERROR: Shorebird reports an existing release, but patching failed." | tee -a "$SHOREBIRD_LOG"
                echo "Please check the Shorebird console or bump your app version." | tee -a "$SHOREBIRD_LOG"
                echo "ðŸ’¾ Saving Shorebird log as artifact due to error"
                kill $KEEPALIVE_PID 2>/dev/null || true
                exit 1
              else
                echo -e "\nâŒ ERROR: An unexpected error occurred during release creation." | tee -a "$SHOREBIRD_LOG"
                echo "$RELEASE_OUTPUT" | tee -a "$SHOREBIRD_LOG"
                echo "ðŸ’¾ Saving Shorebird log as artifact due to error"
                kill $KEEPALIVE_PID 2>/dev/null || true
                exit 1
              fi
            else
              echo -e "\nâŒ ERROR: An unexpected error occurred during patch attempt." | tee -a "$SHOREBIRD_LOG"
              echo "$PATCH_OUTPUT" | tee -a "$SHOREBIRD_LOG"
              echo "ðŸ’¾ Saving Shorebird log as artifact due to error"
              kill $KEEPALIVE_PID 2>/dev/null || true
              exit 1
            fi
            
            # Clean up keepalive process
            kill $KEEPALIVE_PID 2>/dev/null || true

      - run:
          name: Printing logs
          when: on_fail
          command: |
            cat shorebird_deploy.log

      # - run:
      #     name: Store Shorebird artifacts on failure
      #     command: |
      #       circleci-agent store_artifacts shorebird_deploy.log shorebird-logs

      # Save combined cache for both Flutter and Gradle dependencies
      - save_cache:
          paths:
            - ~/.pub-cache
            - ~/.gradle
          key: flutter-deps-v1-{{ checksum "pubspec.lock" }}
          when: always


      - store_artifacts:
          path: build/app/outputs/bundle/release/app-release.aab
          destination: release-aab
          # Note: For Shorebird builds, artifacts may be in different locations

workflows:
  say-hello-workflow:
    jobs:
      - build